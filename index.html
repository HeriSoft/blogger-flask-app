<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blogger</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom CSS for the modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        button:hover {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-gray-800 px-6 py-4 text-white flex justify-between items-center">
        <div class="text-xl font-semibold">Blogger</div>
        <nav>
            <ul class="flex space-x-4">
                <li><a href="./index.html" class="hover:text-yellow-500">Home</a></li>
                <li><a href="./apps/comics.html" class="hover:text-yellow-500">Comics</a></li>
                <li><a href="./apps/stories.html" class="hover:text-yellow-500">Stories</a></li>
                <li><a href="./apps/videos.html" class="hover:text-yellow-500">Videos</a></li>
                <li><a href="./apps/tools.html" class="hover:text-yellow-500">Tools</a></li>
            </ul>
        </nav>
        <div class="flex items-center space-x-4">
            <!-- Thanh t√¨m ki·∫øm -->
            <div class="flex items-stretch flex-grow max-w-md">
                <input type="text" placeholder="T√¨m ki·∫øm b√†i vi·∫øt..." class="px-4 py-2 border rounded-l-lg focus:outline-none flex-grow h-10 text-black">
                <button class="px-6 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 flex items-center justify-center h-10">
                    <i class="fas fa-search"></i> <!-- Icon k√≠nh l√∫p -->
                </button>
            </div>
            <!-- Ph·∫ßn ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω -->
            <div id="authSection">
                <!-- Form ƒëƒÉng nh·∫≠p (m·∫∑c ƒë·ªãnh) -->
                <div id="loginForm" class="flex items-center">
                    <input type="text" id="username" placeholder="Username" class="px-2 py-1 mr-2 text-black">
                    <input type="password" id="password" placeholder="Password" class="px-2 py-1 mr-2 text-black">
                    <button id="loginBtn" class="px-4 py-1 bg-yellow-500 hover:bg-yellow-600 rounded text-black">Login</button>
                    <p class="ml-2 text-white">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="showRegisterForm" class="text-blue-500 hover:underline">ƒêƒÉng k√Ω</a></p>
                </div>
                <!-- N√∫t Panel v√† Logout (·∫©n m·∫∑c ƒë·ªãnh) -->
                <div id="adminPanel" class="hidden">
                    <a href="#" id="adminPanelLink" class="px-4 py-1 bg-blue-500 hover:bg-blue-600 rounded text-white">Panel</a>
                    <span id="userName" class="px-4 py-1 text-white">${user.username}</span>
                    <button id="logoutBtn" class="px-4 py-1 bg-red-500 hover:bg-red-600 rounded text-white ml-2">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Thumbnail Section -->
    <div id="thumbnailSection" class="thumbnail mb-8 relative h-64" style="background-image: url('https://via.placeholder.com/1200x300'); background-size: cover; background-position: center;">
        <!-- Avatar and Bio Section -->
        <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
            <img id="avatarImageElement" src="https://via.placeholder.com/100" alt="Avatar" class="w-24 h-24 rounded-full mb-4 hover:scale-110 transition-transform">
            <p id="bioElement" class="text-white text-lg">M√¥ t·∫£ ng·∫Øn v·ªÅ b·∫£n th√¢n</p>
        </div>
    </div>

    <!-- Modal for Register Form -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">ƒêƒÉng k√Ω th√†nh vi√™n</h2>
            <input type="text" id="registerUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="w-full p-2 mb-4 border rounded">
            <input type="password" id="registerPassword" placeholder="M·∫≠t kh·∫©u" class="w-full p-2 mb-4 border rounded">
            <input type="email" id="registerEmail" placeholder="Email" class="w-full p-2 mb-4 border rounded">
            <button id="registerBtn" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">ƒêƒÉng k√Ω</button>
            <div class="mt-4 text-center">
                <p class="text-gray-600">Ho·∫∑c ƒëƒÉng k√Ω b·∫±ng:</p>
                <button id="googleRegisterBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Google</button>
                <button id="githubRegisterBtn" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700 ml-2">GitHub</button>
            </div>
            <p class="mt-4 text-center">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="showLoginFormModal" class="text-blue-500 hover:underline">ƒêƒÉng nh·∫≠p</a></p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.
        </div>

        <!-- Thumbnail Section -->
        <div id="thumbnailSection" class="thumbnail mb-8" style="background-image: url('https://via.placeholder.com/1200x300');">
            <!-- Thumbnail content (optional) -->
        </div>

        <!-- Layout: B√†i vi·∫øt b√™n tr√°i, Tiers b√™n ph·∫£i -->
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- B√†i vi·∫øt (Left) -->
            <div class="w-full lg:w-2/3">
                <h2 class="text-2xl font-bold mb-4">B√†i vi·∫øt m·ªõi nh·∫•t</h2>
                <div class="space-y-6" id="postsContainer">
                    <!-- C√°c b√†i vi·∫øt s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                </div>
                <!-- Ph√¢n trang -->
                <div id="pagination" class="mt-6 flex justify-center space-x-2">
                    <!-- Ph√¢n trang s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                </div>
                <!-- Th√¥ng b√°o khi kh√¥ng c√≥ b√†i vi·∫øt -->
                <div id="noPostsMessage" class="hidden text-center text-gray-600">
                    Hi·ªán kh√¥ng c√≥ b√†i vi·∫øt n√†o.
                </div>
            </div>

            <!-- Tiers Plan (Right) -->
            <div class="w-full lg:w-1/3">
                <h2 class="text-2xl font-bold mb-4">C√°c g√≥i ƒëƒÉng k√Ω</h2>
                <div class="space-y-6" id="tiersContainer">
                    <!-- C√°c g√≥i ƒëƒÉng k√Ω s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                </div>
                <!-- Th√¥ng b√°o khi kh√¥ng c√≥ g√≥i ƒëƒÉng k√Ω -->
                <div id="noTiersMessage" class="hidden text-center text-gray-600">
                    Hi·ªán kh√¥ng c√≥ g√≥i ƒëƒÉng k√Ω n√†o.
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 px-6 py-4 text-white flex justify-center items-center">
        <div class="text-sm">¬© 2026 Blogger. All rights reserved</div>
    </footer>

    <!-- Scripts -->
    <script>
        // L∆∞u tr·ªØ danh s√°ch ng∆∞·ªùi d√πng
        let users = JSON.parse(localStorage.getItem("users")) || [];
        let posts = JSON.parse(localStorage.getItem("posts")) || [];

        // T·∫°o t√†i kho·∫£n admin m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
        if (!users.some(user => user.username === "admin")) {
            const adminUser = {
                id: Date.now(),
                username: "admin",
                password: "admin",
                email: "admin@example.com",
                role: "admin",
                tier: 0,
                avatar: "",
                paymentMethods: [],
            };
            users.push(adminUser);
            localStorage.setItem("users", JSON.stringify(users));
        }

        // X·ª≠ l√Ω ƒëƒÉng k√Ω
        document.getElementById("registerBtn").addEventListener("click", function () {
            const username = document.getElementById("registerUsername").value;
            const password = document.getElementById("registerPassword").value;
            const email = document.getElementById("registerEmail").value;

            if (username && password && email) {
                // Ki·ªÉm tra xem t√™n ƒëƒÉng nh·∫≠p ho·∫∑c email ƒë√£ t·ªìn t·∫°i ch∆∞a
                const isUsernameTaken = users.some(user => user.username === username);
                const isEmailTaken = users.some(user => user.email === email);

                if (isUsernameTaken) {
                    alert("T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i.");
                    return;
                }
                if (isEmailTaken) {
                    alert("Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.");
                    return;
                }

                // G√°n vai tr√≤ "admin" n·∫øu t√™n ƒëƒÉng nh·∫≠p l√† "admin"
                const role = username === "admin" ? "admin" : "user";

                const newUser = {
                    id: Date.now(), // T·∫°o ID duy nh·∫•t
                    username,
                    password,
                    email,
                    role,
                    tier: 0, // M·∫∑c ƒë·ªãnh ch∆∞a ƒëƒÉng k√Ω g√≥i
                    avatar: "", // Avatar m·∫∑c ƒë·ªãnh
                    paymentMethods: [], // Ph∆∞∆°ng th·ª©c thanh to√°n
                };

                // L∆∞u th√¥ng tin user v√†o localStorage
                users.push(newUser);
                localStorage.setItem("users", JSON.stringify(users));
                localStorage.setItem("user", JSON.stringify(newUser)); // ƒêƒÉng nh·∫≠p ngay sau khi ƒëƒÉng k√Ω
                alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
                checkLoginStatus(); // C·∫≠p nh·∫≠t giao di·ªán
                closeModal(); // ƒê√≥ng modal sau khi ƒëƒÉng k√Ω th√†nh c√¥ng
            } else {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.");
            }
        });

        // Hi·ªÉn th·ªã modal ƒëƒÉng k√Ω
        document.getElementById("showRegisterForm").addEventListener("click", function (e) {
            e.preventDefault();
            openModal();
        });

        // ƒê√≥ng modal
        document.querySelector(".close").addEventListener("click", function () {
            closeModal();
        });

        // M·ªü modal
        function openModal() {
            document.getElementById("registerModal").style.display = "block";
        }

        // ƒê√≥ng modal
        function closeModal() {
            document.getElementById("registerModal").style.display = "none";
        }

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function checkLoginStatus() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (user) {
                if (user.role === "admin") {
                    document.getElementById("loginForm").classList.add("hidden");
                    document.getElementById("adminPanel").classList.remove("hidden");
                } else {
                    document.getElementById("loginForm").classList.add("hidden");
                    document.getElementById("adminPanel").classList.remove("hidden");
                    document.getElementById("adminPanelLink").style.display = "none";
                    document.getElementById("userName").textContent = user.username;

                    // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng k√Ω g√≥i n√†o ch∆∞a
                    if (user.tier) {
                        const tierButtons = document.querySelectorAll(`button[onclick^="subscribeToTier(${user.tier}"]`);
                        tierButtons.forEach(button => button.style.display = "none");
                    }
                }
            } else {
                document.getElementById("loginForm").classList.remove("hidden");
                document.getElementById("adminPanel").classList.add("hidden");
            }
        }

        // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
        document.getElementById("loginBtn").addEventListener("click", function () {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            // Ki·ªÉm tra th√¥ng tin ƒëƒÉng nh·∫≠p
            const user = users.find(user => user.username === username && user.password === password);

            if (user) {
                localStorage.setItem("user", JSON.stringify(user)); // L∆∞u th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
                alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
                checkLoginStatus(); // C·∫≠p nh·∫≠t giao di·ªán
            } else {
                alert("T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.");
            }
        });

        // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
        document.getElementById("logoutBtn").addEventListener("click", function () {
            localStorage.removeItem("user"); // X√≥a th√¥ng tin ng∆∞·ªùi d√πng hi·ªán t·∫°i
            checkLoginStatus(); // C·∫≠p nh·∫≠t giao di·ªán
            renderPosts(); // Hi·ªÉn th·ªã l·∫°i b√†i vi·∫øt
            renderTiers(); // Hi·ªÉn th·ªã l·∫°i c√°c g√≥i ƒëƒÉng k√Ω
        });

        // X·ª≠ l√Ω khi nh·∫•n v√†o n√∫t "Panel"
        document.getElementById("adminPanelLink").addEventListener("click", function (e) {
            e.preventDefault(); // NgƒÉn ch·∫∑n h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa th·∫ª <a>

            const user = JSON.parse(localStorage.getItem("user"));
            if (user && user.role === "admin") {
                // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang admin panel n·∫øu ng∆∞·ªùi d√πng l√† admin
                window.location.href = "/blogger/admin/dashboard.html";
            } else {
                // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu ng∆∞·ªùi d√πng kh√¥ng ph·∫£i l√† admin
                alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin panel.");
            }
        });

        // Hi·ªÉn th·ªã b√†i vi·∫øt
        function renderPosts() {
            const postsContainer = document.getElementById("postsContainer");
            const noPostsMessage = document.getElementById("noPostsMessage");
            const posts = JSON.parse(localStorage.getItem("posts")) || [];
            const user = JSON.parse(localStorage.getItem("user"));

            if (posts.length > 0) {
                const start = (currentPage - 1) * postsPerPage;
                const end = start + postsPerPage;
                const paginatedPosts = posts.slice(start, end);

                postsContainer.innerHTML = paginatedPosts
                    .map((post) => {
                        // Ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ quy·ªÅn xem b√†i vi·∫øt kh√¥ng
                        const canViewPost = user?.role === "admin" || post.tier === "0" || (user?.tier && post.tier <= user.tier);

                        // ƒê·∫£m b·∫£o postInteractions[post.id] t·ªìn t·∫°i
                        if (!postInteractions[post.id]) {
                            postInteractions[post.id] = { likes: new Set(), comments: [] };
                        }

                        // L·∫•y s·ªë l∆∞·ª£t like v√† b√¨nh lu·∫≠n
                        const likes = postInteractions[post.id].likes.size || 0;
                        const comments = postInteractions[post.id].comments || [];

                        return `
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <!-- Thumbnail -->
                                ${post.thumbnail ? `<img src="${post.thumbnail}" alt="Thumbnail" class="w-full h-48 object-cover mb-4 rounded-lg">` : ""}
                                <!-- Ti√™u ƒë·ªÅ v√† n·ªôi dung -->
                                <h3 class="text-xl font-semibold mb-2">${post.title}</h3>
                                ${canViewPost ? `<p class="text-gray-700">${post.content}</p>` : ""}
                                <!-- Video -->
                                ${canViewPost && post.video ? `<div class="mt-4"><iframe src="${post.video}" class="w-full h-64" frameborder="0" allowfullscreen></iframe></div>` : ""}
                                <!-- Kh√≥a b√†i vi·∫øt theo Tiers Plan -->
                                ${!canViewPost ? `
                                    <div class="mt-4 bg-yellow-100 p-4 rounded-lg text-yellow-700">
                                        B√†i vi·∫øt n√†y y√™u c·∫ßu g√≥i ƒëƒÉng k√Ω <strong>${getTierName(post.tier)}</strong>.
                                    </div>
                                ` : ""}
                                <!-- N√∫t Like v√† b√¨nh lu·∫≠n -->
                                ${canViewPost ? `
                                    <div class="mt-4 flex justify-between items-center">
                                        <div class="flex items-center space-x-4">
                                            <button onclick="toggleLike(${post.id})" class="flex items-center space-x-1 text-red-500 hover:text-red-600">
                                                <span>‚ù§Ô∏è</span>
                                                <span>${likes}</span>
                                            </button>
                                            <button onclick="toggleCommentSection(${post.id})" class="flex items-center space-x-1 text-blue-500 hover:text-blue-600">
                                                <span>üí¨</span>
                                                <span>${comments.length}</span>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Khung b√¨nh lu·∫≠n -->
                                    <div id="commentSection-${post.id}" class="hidden mt-4">
                                        <textarea id="commentInput-${post.id}" class="w-full p-2 border rounded" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."></textarea>
                                        <button onclick="submitComment(${post.id})" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">G·ª≠i</button>
                                        <!-- Danh s√°ch b√¨nh lu·∫≠n -->
                                        <div class="mt-4">
                                            ${renderComments(post.id)}
                                        </div>
                                    </div>
                                ` : ""}
                            </div>
                        `;
                    })
                    .join("");
                noPostsMessage.classList.add("hidden");
            } else {
                postsContainer.innerHTML = "";
                noPostsMessage.classList.remove("hidden");
            }
        }

        // ·∫©n b√¨nh lu·∫≠n
        function toggleCommentSection(postId) {
            const commentSection = document.getElementById(`commentSection-${postId}`);
            if (commentSection) {
                commentSection.classList.toggle("hidden");
                if (!commentSection.classList.contains("hidden")) {
                    commentSection.scrollIntoView({ behavior: "smooth", block: "start" });
                }
            }
        }

        // Th√™m b√¨nh lu·∫≠n
        function submitComment(postId) {
            const commentInput = document.getElementById(`commentInput-${postId}`);
            if (commentInput && commentInput.value.trim()) {
                addComment(postId, commentInput.value.trim());
                commentInput.value = ""; // X√≥a n·ªôi dung sau khi g·ª≠i
            }
        }

        // Ph√¢n trang
        let currentPage = 1;
        const postsPerPage = 4; // Hi·ªÉn th·ªã 4 b√†i vi·∫øt m·ªói trang

        function renderPagination() {
            const pagination = document.getElementById("pagination");
            const totalPages = Math.ceil(posts.length / postsPerPage);
            let paginationHTML = "";

            // N√∫t "Previous"
            if (currentPage > 1) {
                paginationHTML += `
                    <button onclick="changePage(${currentPage - 1})" class="px-3 py-1 rounded bg-gray-200">Previous</button>
                `;
            }

            // C√°c n√∫t trang
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button onclick="changePage(${i})" class="px-3 py-1 rounded ${currentPage === i ? 'bg-blue-500 text-white' : 'bg-gray-200'}">${i}</button>
                `;
            }

            // N√∫t "Next"
            if (currentPage < totalPages) {
                paginationHTML += `
                    <button onclick="changePage(${currentPage + 1})" class="px-3 py-1 rounded bg-gray-200">Next</button>
                `;
            }

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            currentPage = page;
            renderPosts();
            renderPagination();
        }

        // Hi·ªÉn th·ªã c√°c g√≥i ƒëƒÉng k√Ω
        function renderTiers() {
            const tiersContainer = document.getElementById("tiersContainer");
            const noTiersMessage = document.getElementById("noTiersMessage");
            const tiers = JSON.parse(localStorage.getItem("tiers")) || [];
            const user = JSON.parse(localStorage.getItem("user"));

            if (tiers.length > 0) {
                tiersContainer.innerHTML = tiers
                    .map(
                        (tier) => `
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">${tier.name} - $${tier.price}</h3>
                            <ul class="list-disc list-inside text-sm text-gray-600 mt-2">
                                ${tier.benefits.map((benefit) => `<li>${benefit}</li>`).join("")}
                            </ul>
                            ${user?.role !== "admin" ? `
                                <button onclick="subscribeToTier(${tier.id}, ${tier.price})" class="mt-4 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">ƒêƒÉng k√Ω</button>
                            ` : ""}
                        </div>
                    `
                    )
                    .join("");
                noTiersMessage.classList.add("hidden");
            } else {
                tiersContainer.innerHTML = "";
                noTiersMessage.classList.remove("hidden");
            }
        }

        // L∆∞u g√≥i ƒëƒÉng k√Ω c·ªßa user
        function subscribeToTier(tierId, price) {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng k√Ω g√≥i.");
                return;
            }

            // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
            if (!tierId || !price || price <= 0) {
                alert("Th√¥ng tin g√≥i ƒëƒÉng k√Ω kh√¥ng h·ª£p l·ªá.");
                return;
            }

            // Hi·ªÉn th·ªã loading state (v√≠ d·ª•: disable n√∫t ƒëƒÉng k√Ω ho·∫∑c hi·ªÉn th·ªã spinner)
            const subscribeButton = document.querySelector(`button[onclick*="subscribeToTier(${tierId}"]`);
            if (subscribeButton) {
                subscribeButton.disabled = true;
                subscribeButton.textContent = "ƒêang x·ª≠ l√Ω...";
            }

            // G·ªçi API thanh to√°n
            fetch('/api/payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tierId: tierId, price: price, userId: user.id }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng sau khi thanh to√°n th√†nh c√¥ng
                    user.tier = tierId;
                    localStorage.setItem("user", JSON.stringify(user));

                    // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang thank-you.html
                    window.location.href = "/thank-you.html";
                } else {
                    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói t·ª´ server (n·∫øu c√≥)
                    alert(data.message || "Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
                }
            })
            .catch(error => {
                console.error("L·ªói khi g·ªçi API thanh to√°n:", error);
                alert("C√≥ l·ªói x·∫£y ra khi th·ª±c hi·ªán thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i sau.");
            })
            .finally(() => {
                // ·∫®n loading state (v√≠ d·ª•: enable l·∫°i n√∫t ƒëƒÉng k√Ω)
                if (subscribeButton) {
                    subscribeButton.disabled = false;
                    subscribeButton.textContent = "ƒêƒÉng k√Ω";
                }
            });
        }

        // L·∫•y t√™n g√≥i ƒëƒÉng k√Ω
        function getTierName(tier) {
            switch (tier) {
                case "0":
                    return "M·ªü kh√≥a cho t·∫•t c·∫£";
                case "1":
                    return "C∆° B·∫£n";
                case "2":
                    return "N√¢ng Cao";
                case "3":
                    return "Cao C·∫•p";
                default:
                    return "";
            }
        }

        // H√†m hi·ªÉn th·ªã th√¥ng tin banner v√† avatar
        function renderBannerAvatarInfo() {
            // L·∫•y d·ªØ li·ªáu t·ª´ localStorage
            const bannerAvatarInfo = JSON.parse(localStorage.getItem("bannerAvatarInfo")) || {};

            // Hi·ªÉn th·ªã cover image
            const thumbnailSection = document.getElementById("thumbnailSection");
            if (bannerAvatarInfo.coverImage) {
                thumbnailSection.style.backgroundImage = `url('${bannerAvatarInfo.coverImage}')`;
            } else {
                thumbnailSection.style.backgroundImage = "url('https://via.placeholder.com/1200x300')";
            }

            // Hi·ªÉn th·ªã avatar
            const avatarImageElement = document.getElementById("avatarImageElement");
            if (bannerAvatarInfo.avatarImage) {
                avatarImageElement.src = bannerAvatarInfo.avatarImage;
            } else {
                avatarImageElement.src = "https://via.placeholder.com/100";
            }

            // Hi·ªÉn th·ªã m√¥ t·∫£
            const bioElement = document.getElementById("bioElement");
            if (bannerAvatarInfo.bio) {
                bioElement.textContent = bannerAvatarInfo.bio;
            } else {
                bioElement.textContent = "M√¥ t·∫£ ng·∫Øn v·ªÅ b·∫£n th√¢n";
            }
        }

        // L∆∞u tr·ªØ th√¥ng tin Like v√† b√¨nh lu·∫≠n
        let postInteractions = JSON.parse(localStorage.getItem("postInteractions")) || {};

        // H√†m th√™m/x√≥a Like
        function toggleLike(postId) {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) {
                Swal.fire("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch b√†i vi·∫øt.");
                return;
            }

            // ƒê·∫£m b·∫£o postInteractions[postId] t·ªìn t·∫°i v√† likes l√† Set
            if (!postInteractions[postId]) {
                postInteractions[postId] = {
                    likes: new Set(),
                    comments: [],
                };
            }

            if (!(postInteractions[postId].likes instanceof Set)) {
                postInteractions[postId].likes = new Set(postInteractions[postId].likes);
            }

            const likes = postInteractions[postId].likes;
            if (likes.has(user.id)) {
                likes.delete(user.id);
            } else {
                likes.add(user.id);
            }

            localStorage.setItem("postInteractions", JSON.stringify(postInteractions, replacer));
            renderPosts();
        }

        function addComment(postId, commentText) {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user) {
                Swal.fire("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n.");
                return;
            }

            // ƒê·∫£m b·∫£o postInteractions[postId] t·ªìn t·∫°i
            if (!postInteractions[postId]) {
                postInteractions[postId] = {
                    likes: new Set(),
                    comments: [],
                };
            }

            // T·∫°o b√¨nh lu·∫≠n m·ªõi
            const comment = {
                id: Date.now(), // T·∫°o ID duy nh·∫•t cho b√¨nh lu·∫≠n
                userId: user.id,
                username: user.username,
                text: commentText,
                timestamp: new Date().toLocaleString(), // Th√™m th·ªùi gian b√¨nh lu·∫≠n
            };

            // Th√™m b√¨nh lu·∫≠n v√†o m·∫£ng comments
            postInteractions[postId].comments.push(comment);

            // L∆∞u l·∫°i postInteractions v√†o localStorage
            localStorage.setItem("postInteractions", JSON.stringify(postInteractions, replacer));

            // C·∫≠p nh·∫≠t giao di·ªán
            renderPosts();
        }

        // H√†m hi·ªÉn th·ªã b√¨nh lu·∫≠n
        function renderComments(postId) {
            const comments = postInteractions[postId]?.comments || [];
            const user = JSON.parse(localStorage.getItem("user"));

            return comments
                .map(
                    (comment) => `
                        <div class="mt-4 p-4 bg-gray-100 rounded-lg">
                            <p class="text-sm font-semibold">${comment.username}</p>
                            ${user?.id === comment.userId ? `
                                <textarea id="editComment-${comment.id}" class="w-full p-2 border rounded hidden">${comment.text}</textarea>
                                <p class="text-sm text-gray-600" id="commentText-${comment.id}">${comment.text}</p>
                            ` : `<p class="text-sm text-gray-600">${comment.text}</p>`}
                            <p class="text-xs text-gray-400 mt-1">${comment.timestamp}</p>
                            ${user?.id === comment.userId ? `
                                <button onclick="editComment(${postId}, ${comment.id})" class="text-blue-500 text-xs hover:text-blue-600">Ch·ªânh s·ª≠a</button>
                                <button onclick="saveComment(${postId}, ${comment.id})" class="text-green-500 text-xs hover:text-green-600 hidden" id="saveButton-${comment.id}">L∆∞u</button>
                                <button onclick="deleteComment(${postId}, ${comment.id})" class="text-red-500 text-xs hover:text-red-600">X√≥a</button>
                            ` : ""}
                        </div>
                    `
                )
                .join("");
        }

        function editComment(postId, commentId) {
            const commentText = document.getElementById(`commentText-${commentId}`);
            const editTextarea = document.getElementById(`editComment-${commentId}`);
            const saveButton = document.getElementById(`saveButton-${commentId}`);

            commentText.classList.add("hidden");
            editTextarea.classList.remove("hidden");
            saveButton.classList.remove("hidden");
        }

        function saveComment(postId, commentId) {
            const editTextarea = document.getElementById(`editComment-${commentId}`);
            const newText = editTextarea.value.trim();

            if (newText) {
                const commentIndex = postInteractions[postId].comments.findIndex(
                    (comment) => comment.id === commentId
                );
                postInteractions[postId].comments[commentIndex].text = newText;
                localStorage.setItem("postInteractions", JSON.stringify(postInteractions));
                renderPosts();
                Swal.fire("B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!");
            }
        }

        function deleteComment(postId, commentId) {
            postInteractions[postId].comments = postInteractions[postId].comments.filter(
                (comment) => comment.id !== commentId
            );
            localStorage.setItem("postInteractions", JSON.stringify(postInteractions));
            renderPosts();
            Swal.fire("B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c x√≥a!");
        }

        // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c m·ªü
        window.addEventListener("load", function () {
            // Kh·ªüi t·∫°o postInteractions t·ª´ localStorage
            let postInteractions = JSON.parse(localStorage.getItem("postInteractions"), reviver) || {};

            // ƒê·∫£m b·∫£o m·ªói b√†i vi·∫øt ƒë·ªÅu c√≥ entry trong postInteractions
            const posts = JSON.parse(localStorage.getItem("posts")) || [];
            posts.forEach((post) => {
                if (!postInteractions[post.id]) {
                    postInteractions[post.id] = {
                        likes: new Set(),
                        comments: [], // ƒê·∫£m b·∫£o comments l√† m·ªôt m·∫£ng
                    };
                }
            });

            // L∆∞u l·∫°i postInteractions ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            localStorage.setItem("postInteractions", JSON.stringify(postInteractions, replacer));

            // C√°c h√†m kh√°c
            checkLoginStatus();
            renderPosts();
            renderTiers();
            renderBannerAvatarInfo();
        });

        // Th√™m h√†m replacer ƒë·ªÉ x·ª≠ l√Ω Set khi l∆∞u v√†o localStorage
        function replacer(key, value) {
            if(value instanceof Set) {
                return {
                    dataType: 'Set',
                    value: Array.from(value)
                };
            }
            return value;
        }

        // Th√™m reviver khi parse t·ª´ localStorage
        postInteractions = JSON.parse(localStorage.getItem("postInteractions"), (key, value) => {
            if (typeof value === 'object' && value !== null && value.dataType === 'Set') {
                return new Set(value.value);
            }
            return value;
        }) || {};

        // H√†m replacer ƒë·ªÉ x·ª≠ l√Ω Set khi l∆∞u v√†o localStorage
        function replacer(key, value) {
            if (value instanceof Set) {
                return {
                    dataType: 'Set',
                    value: Array.from(value),
                };
            }
            return value;
        }

        // H√†m reviver ƒë·ªÉ chuy·ªÉn ƒë·ªïi m·∫£ng th√†nh Set khi ƒë·ªçc t·ª´ localStorage
        function reviver(key, value) {
            if (typeof value === 'object' && value !== null && value.dataType === 'Set') {
                return new Set(value.value);
            }
            return value;
        }
        
    </script>
</body>
</html>